---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: container-types
spec:
  replicas: 1
  selector:
    matchLabels:
      app: container-types
  template:
    metadata:
      labels:
        app: container-types
    spec:
      volumes:
        - name: web
          emptyDir: {}
      initContainers:
        - name: init-web
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cat >/work/index.html <<'EOF'
              <!doctype html>
              <html>
                <head>
                  <meta charset="utf-8" />
                  <title>Container Types Demo</title>
                  <style>body{font-family:system-ui, sans-serif; padding:20px}</style>
                  <script>
                    async function poll() {
                      try {
                        const r = await fetch('heartbeat.txt', { cache: 'no-store' });
                        document.getElementById('heartbeat').textContent = await r.text();
                      } catch (e) {
                        document.getElementById('heartbeat').textContent = 'unavailable';
                      }
                      setTimeout(poll, 2000);
                    }
                    window.onload = poll;
                  </script>
                </head>
                <body>
                  <h1>Init + Sidecar with NGINX</h1>
                  <p>Pod: <strong id="pod"></strong></p>
                  <p>Node: <strong id="node"></strong></p>
                  <p>Sidecar heartbeat: <pre id="heartbeat">startingâ€¦</pre></p>
                  <script>
                    document.getElementById('pod').textContent = '${POD_NAME}';
                    document.getElementById('node').textContent = '${NODE_NAME}';
                  </script>
                </body>
              </html>
              EOF
          volumeMounts:
            - name: web
              mountPath: /work
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
      containers:
        - name: web
          image: nginx:1.25-alpine
          ports:
            - containerPort: 80
          volumeMounts:
            - name: web
              mountPath: /usr/share/nginx/html
        - name: sidecar-writer
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              while true; do
                date -u +"%Y-%m-%dT%H:%M:%SZ" > /work/heartbeat.txt;
                sleep 5;
              done
          volumeMounts:
            - name: web
              mountPath: /work
